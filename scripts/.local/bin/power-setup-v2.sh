#!/bin/bash
#
# TLP-based Power Management Setup for Lenovo P14s Gen3 Intel  
# Uses TLP's built-in AC/BAT profiles for flexible power management
#
# Author: Generated by Claude
# Date: August 4, 2025
#

set -e

echo "=== TLP Power Management Setup ===" 
echo "Using TLP's AC/BAT profiles for flexible power management"
echo

# Install power management packages (TLP only, no power-profiles-daemon)
echo "Step 1: Installing packages..."
sudo pacman -S tlp powertop --needed

# Configure TLP with multiple profiles
echo "Step 2: Configuring TLP with flexible profiles..."
sudo tee /etc/tlp.d/01-thinkpad-p14s.conf > /dev/null << 'EOF'
# TLP configuration for Lenovo ThinkPad P14s Gen3 Intel
# Uses AC/BAT profiles for performance switching

# CPU scaling governor
CPU_SCALING_GOVERNOR_ON_AC=performance
CPU_SCALING_GOVERNOR_ON_BAT=powersave

# CPU energy performance preferences
CPU_ENERGY_PERF_POLICY_ON_AC=balance_performance
CPU_ENERGY_PERF_POLICY_ON_BAT=power

# CPU frequency scaling
CPU_MIN_PERF_ON_AC=0
CPU_MAX_PERF_ON_AC=100
CPU_MIN_PERF_ON_BAT=0
CPU_MAX_PERF_ON_BAT=30

# Processor P-state performance boost
CPU_BOOST_ON_AC=1
CPU_BOOST_ON_BAT=0

# Intel HWP energy performance preference  
CPU_HWP_DYN_BOOST_ON_AC=1
CPU_HWP_DYN_BOOST_ON_BAT=0

# Platform profile
PLATFORM_PROFILE_ON_AC=balanced
PLATFORM_PROFILE_ON_BAT=low-power

# PCIe Active State Power Management
PCIE_ASPM_ON_AC=default
PCIE_ASPM_ON_BAT=powersupersave

# Runtime Power Management
RUNTIME_PM_ON_AC=auto
RUNTIME_PM_ON_BAT=auto

# WiFi power management
WIFI_PWR_ON_AC=off
WIFI_PWR_ON_BAT=on

# USB autosuspend
USB_AUTOSUSPEND=1
EOF

# Create additional conservative profile
echo "Step 3: Creating conservative profile..."
sudo tee /etc/tlp.d/02-conservative.conf > /dev/null << 'EOF'
# Conservative profile - can be activated manually
# Uncomment to override main config for maximum cooling

# CPU_SCALING_GOVERNOR_ON_AC=powersave
# CPU_ENERGY_PERF_POLICY_ON_AC=power
# CPU_MAX_PERF_ON_AC=50
# CPU_BOOST_ON_AC=0
# PLATFORM_PROFILE_ON_AC=low-power
EOF

# Intel graphics power saving
echo "Step 4: Configuring Intel graphics..."
sudo tee /etc/modprobe.d/i915.conf > /dev/null << 'EOF'
options i915 enable_rc6=1 enable_fbc=1 enable_guc=3 enable_psr=1
EOF

# Disable conflicting services
echo "Step 5: Managing services..."
if systemctl is-enabled thermald &>/dev/null; then
    sudo systemctl disable --now thermald
fi
if systemctl is-enabled power-profiles-daemon &>/dev/null; then
    sudo systemctl disable --now power-profiles-daemon
fi
sudo systemctl mask systemd-rfkill.service systemd-rfkill.socket

# Enable TLP
sudo systemctl enable --now tlp

# Set thermal zones
echo "Step 6: Configuring thermal zones..."
for zone in /sys/class/thermal/thermal_zone*/policy; do 
    if [[ -f "$zone" ]]; then
        echo "step_wise" | sudo tee "$zone" > /dev/null
    fi
done

# Apply optimizations
echo "Step 7: Applying optimizations..."
sudo powertop --auto-tune

# Start in battery mode for conservative operation
sudo tlp bat
sudo tlp start

echo
echo "=== Setup Complete ==="
echo
echo "Power management commands:"
echo "  sudo tlp ac        # Performance mode (AC profile)"
echo "  sudo tlp bat       # Power saving mode (BAT profile)"  
echo "  sudo tlp start     # Apply current settings"
echo
echo "Current mode: Battery (conservative)"
echo "Switch to performance: sudo tlp ac"
echo
echo "Reboot recommended for full effect"