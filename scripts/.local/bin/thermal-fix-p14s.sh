#!/bin/bash
#
# Thermal Fix for Lenovo P14s Gen3 Intel on Arch Linux
# Fixes overheating issues by configuring proper power management
#
# Author: Generated by Claude
# Date: August 4, 2025
# System: Lenovo ThinkPad P14s Gen3 Intel (i7-1260P)
#

set -e

echo "=== Lenovo P14s Gen3 Intel Thermal Fix ==="
echo "This script will configure thermal management for your laptop"
echo

# Check if running on correct hardware
if ! lscpu | grep -q "i7-1260P"; then
    echo "WARNING: This script is designed for Intel i7-1260P (P14s Gen3)"
    echo "Current CPU: $(lscpu | grep "Model name" | cut -d: -f2 | xargs)"
    read -p "Continue anyway? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

echo "Step 1: Installing power management packages..."
sudo pacman -S tlp powertop --needed

echo "Step 2: Configuring TLP..."
sudo tee /etc/tlp.d/01-thinkpad-p14s.conf > /dev/null << 'EOF'
# Custom TLP configuration for Lenovo ThinkPad P14s Gen3 Intel
# Optimized for low temperatures and power consumption

# Operation mode on AC power
TLP_DEFAULT_MODE=AC

# CPU scaling governor
CPU_SCALING_GOVERNOR_ON_AC=powersave
CPU_SCALING_GOVERNOR_ON_BAT=powersave

# CPU energy performance preferences
CPU_ENERGY_PERF_POLICY_ON_AC=power
CPU_ENERGY_PERF_POLICY_ON_BAT=power

# CPU frequency scaling
CPU_MIN_PERF_ON_AC=0
CPU_MAX_PERF_ON_AC=70
CPU_MIN_PERF_ON_BAT=0
CPU_MAX_PERF_ON_BAT=50

# Processor P-state performance boost
CPU_BOOST_ON_AC=0
CPU_BOOST_ON_BAT=0

# Intel HWP energy performance preference
CPU_HWP_DYN_BOOST_ON_AC=0
CPU_HWP_DYN_BOOST_ON_BAT=0

# Platform profile
PLATFORM_PROFILE_ON_AC=low-power
PLATFORM_PROFILE_ON_BAT=low-power

# PCIe Active State Power Management
PCIE_ASPM_ON_AC=powersupersave
PCIE_ASPM_ON_BAT=powersupersave

# Runtime Power Management for PCI(e) devices
RUNTIME_PM_ON_AC=auto
RUNTIME_PM_ON_BAT=auto

# WiFi power management
WIFI_PWR_ON_AC=on
WIFI_PWR_ON_BAT=on

# Disable USB autosuspend for now (can cause issues)
USB_AUTOSUSPEND=0
EOF

echo "Step 3: Configuring Intel graphics power saving..."
sudo tee /etc/modprobe.d/i915.conf > /dev/null << 'EOF'
options i915 enable_rc6=1 enable_fbc=1 enable_guc=3 enable_psr=1
EOF

echo "Step 4: Disabling conflicting services..."
# Disable thermald (causes conflicts with kernel thermal management)
if systemctl is-enabled thermald &>/dev/null; then
    echo "Disabling thermald (conflicts with kernel thermal management)..."
    sudo systemctl disable --now thermald
fi

# Mask conflicting rfkill services
sudo systemctl mask systemd-rfkill.service systemd-rfkill.socket

echo "Step 5: Enabling TLP..."
sudo systemctl enable --now tlp

echo "Step 6: Configuring thermal zones..."
# Set all thermal zones to use kernel's step_wise policy
for zone in /sys/class/thermal/thermal_zone*/policy; do 
    if [[ -f "$zone" ]]; then
        echo "step_wise" | sudo tee "$zone" > /dev/null
    fi
done

echo "Step 7: Applying immediate optimizations..."
# Apply PowerTOP auto-tuning
sudo powertop --auto-tune

# Start TLP
sudo tlp start

echo
echo "=== Configuration Complete ==="
echo
echo "Temperature should drop from ~83°C to ~61°C at idle"
echo "Reboot recommended to apply Intel graphics changes"
echo
echo "Monitoring commands:"
echo "  sensors                    # Check temperatures"
echo "  sudo tlp-stat -s          # Check TLP status"
echo "  watch sensors             # Monitor temps continuously"
echo
echo "If you experience issues, check thermal zone policies:"
echo "  cat /sys/class/thermal/thermal_zone*/policy"
echo "  (should all show 'step_wise')"
echo

read -p "Reboot now? (y/N): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    sudo reboot
fi