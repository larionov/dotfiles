#!/bin/bash
#
# Clean Power Management Setup for Lenovo P14s Gen3 Intel
# Uses power-profiles-daemon with defaults + Intel graphics optimization
#
# Author: Generated by Claude
# Date: August 4, 2025
#

set -e

echo "=== Clean Power Management Setup ===" 
echo "Using power-profiles-daemon defaults with Intel graphics optimization"
echo

# Install power management
echo "Step 1: Installing power-profiles-daemon..."
sudo pacman -S power-profiles-daemon --needed

# Intel graphics power saving (keep this optimization)
echo "Step 2: Configuring Intel graphics power saving..."
sudo tee /etc/modprobe.d/i915.conf > /dev/null << 'EOF'
options i915 enable_rc6=1 enable_fbc=1 enable_guc=3 enable_psr=1
EOF

# Disable thermald if present (still conflicts with kernel thermal)
echo "Step 3: Managing conflicting services..."
if systemctl is-enabled thermald &>/dev/null; then
    sudo systemctl disable --now thermald
fi

# Enable power-profiles-daemon
sudo systemctl enable --now power-profiles-daemon

# Set thermal zones to kernel management
echo "Step 4: Configuring thermal zones..."
for zone in /sys/class/thermal/thermal_zone*/policy; do 
    if [[ -f "$zone" ]]; then
        echo "step_wise" | sudo tee "$zone" > /dev/null
    fi
done

# Set to power-saver by default for coolest operation
powerprofilesctl set power-saver

echo
echo "=== Setup Complete ==="
echo
echo "Power profiles available:"
echo "  powerprofilesctl set power-saver    # Coolest operation"
echo "  powerprofilesctl set balanced       # Default performance"
echo "  powerprofilesctl set performance    # Maximum performance"
echo
echo "Current profile: $(powerprofilesctl get)"
echo
echo "Reboot recommended for Intel graphics changes"