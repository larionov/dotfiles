#!/bin/bash
#
# Advanced Power Management Setup for Lenovo P14s Gen3 Intel
# Provides flexible power profiles with thermal optimization
#
# Author: Generated by Claude
# Date: August 4, 2025
#

set -e

echo "=== Advanced Power Management Setup ===" 
echo "Installing power-profiles-daemon + TLP with flexible profiles"
echo

# Install power management packages
echo "Step 1: Installing packages..."
sudo pacman -S power-profiles-daemon tlp powertop --needed

# Configure TLP with conservative thermal settings
echo "Step 2: Configuring TLP for thermal optimization..."
sudo tee /etc/tlp.d/01-thinkpad-p14s.conf > /dev/null << 'EOF'
# TLP configuration for Lenovo ThinkPad P14s Gen3 Intel
# Conservative thermal settings - power-profiles-daemon handles performance switching

# CPU scaling governor - let power-profiles-daemon control this
CPU_SCALING_GOVERNOR_ON_AC=powersave
CPU_SCALING_GOVERNOR_ON_BAT=powersave

# CPU energy performance preferences - conservative defaults
CPU_ENERGY_PERF_POLICY_ON_AC=balance_power
CPU_ENERGY_PERF_POLICY_ON_BAT=power

# CPU frequency scaling - moderate limits to prevent excessive heat
CPU_MIN_PERF_ON_AC=0
CPU_MAX_PERF_ON_AC=80
CPU_MIN_PERF_ON_BAT=0
CPU_MAX_PERF_ON_BAT=40

# Processor P-state performance boost - controlled by power profiles
CPU_BOOST_ON_AC=1
CPU_BOOST_ON_BAT=0

# Platform profile - let power-profiles-daemon manage this
# PLATFORM_PROFILE_ON_AC=balanced
# PLATFORM_PROFILE_ON_BAT=low-power

# PCIe Active State Power Management
PCIE_ASPM_ON_AC=default
PCIE_ASPM_ON_BAT=powersupersave

# Runtime Power Management
RUNTIME_PM_ON_AC=auto
RUNTIME_PM_ON_BAT=auto

# WiFi power management
WIFI_PWR_ON_AC=on
WIFI_PWR_ON_BAT=on

# USB autosuspend
USB_AUTOSUSPEND=1
EOF

# Intel graphics power saving
echo "Step 3: Configuring Intel graphics..."
sudo tee /etc/modprobe.d/i915.conf > /dev/null << 'EOF'
options i915 enable_rc6=1 enable_fbc=1 enable_guc=3 enable_psr=1
EOF

# Disable conflicting services
echo "Step 4: Managing services..."
if systemctl is-enabled thermald &>/dev/null; then
    sudo systemctl disable --now thermald
fi
sudo systemctl mask systemd-rfkill.service systemd-rfkill.socket

# Enable services
sudo systemctl enable --now tlp
sudo systemctl enable --now power-profiles-daemon

# Set thermal zones
echo "Step 5: Configuring thermal zones..."
for zone in /sys/class/thermal/thermal_zone*/policy; do 
    if [[ -f "$zone" ]]; then
        echo "step_wise" | sudo tee "$zone" > /dev/null
    fi
done

# Apply optimizations
echo "Step 6: Applying optimizations..."
sudo powertop --auto-tune
sudo tlp start

# Set default to power-saver for cooler operation
powerprofilesctl set power-saver

echo
echo "=== Setup Complete ==="
echo
echo "Power profiles available:"
echo "  powerprofilesctl set power-saver    # Coolest operation"
echo "  powerprofilesctl set balanced       # Balanced performance"
echo "  powerprofilesctl set performance    # Maximum performance"
echo
echo "Current profile: $(powerprofilesctl get)"
echo
echo "Reboot recommended for full effect"